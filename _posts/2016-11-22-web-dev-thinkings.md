---
layout: post
title: 关于Web开发的一些思考：工具，配置，最佳实践
category: Web开发
tags: [ 'web', 'programming' ]
---

前几天写完了毕业论文，交给老板等着修改意见。趁着这几天没什么事情又爬进了 Web 开发的坑，看了好多 "Get Started" 和 "Tutorial"， 研究了最新的开发工具和框架，试着自己写了几个小网站感受这些工具的力量，收获了一些思考在此分享。

先列举一下涉及到的东西吧：

  * Gulp
  * Webpack
  * React
  * Redux
  * Pug
  * Stylus
  * Babel

## 如果可以选择，我们应该使用那些工具和框架？

抛开加入一个成熟的团队，被迫使用已有框架的情况不谈，如果我们有机会负责一个全新的 Web 项目，整个项目的框架都由自己决定时，选择什么工具将会成为一个至关重要的问题。对于 Web 开发来说，最不缺的就是现成的轮子，所以这个问题对于选择恐惧症患者来说就尤为困难。网上有无数工具可以供我们使用，安装也基本都是简单的一句 `npm install`，每个工具都说自己解决了一个头疼的问题，每个问题都有好几种工具可供我们使用。在这样的环境下，我们到底该如何选择呢？

在选择工具之前，我们应该先思考：我们真的需要一个额外的包来解决某个问题吗？比如当你纠结于 Gulp 还是 Grunt 时（虽然现在基本都会选择 Gulp 了），你应该先问问自己：我真的需要一个自动化构建工具吗？当你纠结于用 pug 还是 markdown 时，你应该先问问自己：我真的需要一个模板吗？

可能有人会说，自动化构建的好处众人皆知，可以省下无数重复工作；模板的好处显而易见，手写HTML是一件多么痛苦的事情。这些观点当然是正确的，但我们在这里讨论的是使用工具的必要性而不是自动化构建的必要性。在决定是否使用某一类工具时，我们应当仔细思考这个项目是否真的需要它，而不能因为别人都使用了我们就使用。此外，各种工具的功能有一部分是重合的，比如工具A有功能1、2、3，工具B有功能3、4、5，很多时候可能我们仅仅需要的是功能2和3，那工具B就完全没有必要加入到我们的依赖列表里了。

这么说看起来有点太浅显，谁都知道刚才说的那种情况没有必要使用工具B，那就用一个真实的例子来说明吧。比如我们想要开发一个纯前端的项目，我们暂时只知道后端负责提供数据，至于后端用什么语言开发，API 什么样，数据格式什么样暂时都还不清楚。我们手里有的资料暂时只有设计师给出的网站样式，以及产品经理给出的交互需求。假设我们想要 React+Redux 作为主要框架来实现，那构建工具我们到底需要那些呢？

面对这样的情况，一部分人可能直接上 Github 找一个模板或者 Yeoman 上找一个合适的 Generator 然后以此为起点就开始了。但我建议在这么做之前最好先仔细思考一下我们到底需要哪些工具，不需要哪些工具，然后再按照思考的结果找模板或者自己从头配置一个。

首先，对于这样的一个项目，写 CSS 是少不了的了，那选用一款自己顺手的CSS预处理语言必不可少，我喜欢 Stylus，所以这毫无疑问是我的依赖项目之一；既然已经决定了用 React+Redux，那一定涉及到大量 JavaScript (JSX) 的编写，那用 Babel 让源代码更简单易懂应该没有什么问题；想到这里，自然会考虑到在 JS 里各种静态资源的引用问题，Webpack 正是解决这个问题的最佳方案；此外，开发过程中为了让代码更规范，有必要选用 ESLint 监督自己。

开发过程需要的工具差不多就是这些了，接下来思考一下测试需要用到的东西吧。测试框架有很多，当然选用一款即可。Jest 测试 React+Redux 算是官方推荐，在这里我们也使用它。

测试完了就该考虑发布的事情了，既然后端什么样还不知道，我们做一个完全由客户端渲染的应用就好了。之前我们已经决定使用 Webpack 打包各种资源，那发布的东西应该就是打包好的 JavaScript，CSS 和图片等，并没有什么额外工作。

对于每一步需要什么我们已经有了大致的印象，接下来我们要考虑需要哪些工具来自动化这些流程。首先想到的是我们需要在发布前自动测试，嗯……那用 Gulp 就好了……吗？

有人会说当然啦，发布前自动测试，这就是 Gulp 再也经典不过的应用场景了。可是如果再仔细想一想的话，如果我们使用 Gulp，那当我们想要发布的时候，我们在 Console 里敲 `gulp deploy`，Gulp 就会自动为我们测试然后把编译好的 JavaScript 放到发布文件夹里，这自然很轻松。但如果我们不使用 Gulp，我们同样可以写一个script，然后在Console里敲 `npm run deploy`，我们同样可以实现自动测试然后把编译好的 JavaScript 放到发布文件夹里。也就是说使用 Gulp 实际上并没有简化我们的工作流程，而却让我们多了一个依赖。这里的主要问题是：我们所做的是一个完全前端的项目，生产出浏览器可以运行的 JavaScript 是我们的唯一目的，在这种情况下，使用 Gulp 并没有为我们带来太大的便利，因为我们的目的太单一了。在全栈项目里，Gulp 才可以发挥出最大的威力，因为有时候我们需要运行一个服务器来看网站的功能是否正常，有时我们需要发布客户端文件，有时我们需要编译服务器端文件。在这种情况下，如果我们手写各种 script，任务之间的依赖关系就需要我们自己来掌握，这会成为额外的负担，所以才有使用 Gulp 的必要性。

这里没有提到 "watch" 的这个功能，因为 Webpack 本身已经提供了监视文件变动的功能，在这一点上二者是重合的。因此，为了 "watch" 而使用 Gulp 是完全没有必要的。但事实上，在 Github 上我也的确见到过几个前端项目为了 watch 而使用 Gulp 的。此时再回顾一下我刚才说的“工具A和工具B”，可能也就没有那么简单了吧。

最后，我们还应该注意到在整个流程中我们都没有使用到任何模板语言，比如 pug 或者 EJS。因为对于 React 项目来说整个 App 是基于 Virtual DOM 而实现的，HTML 的书写都集成在 JSX 里面了，开发者本身并不需要创建额外的 HTML 文件（除了作为整个应用的入口的占位 HTML），所以模板语言并无必要。当然，如果连 JSX 里面的 HTML 也不想写，也有一些库提供了 pug 到 JSX 的方法。

一个基于 React 的前端项目不需要模板语言，不需要自动化构建工具，这可能会有一点出乎意料，但这正显示出了开发之前思考的意义，上面给出的例子也不代表所有情况。针对不同的实际情况，我们所需要的工具都是不一样的，Github 上的项目为了保证其通用性大多包含了多于必需的依赖。但在实际开发中这种多于必需往往会造成混乱（或者单纯的只是有强迫症不爽），我们应该具体情况具体分析。

总结一下，在选用什么工具这个问题上，我的原则就是：在能解决问题的前提下，尽量选择最少的工具。额外的工具虽然会减少代码量，但却会增加配置的额外工作，在这两者中，我还是更倾向于多写一点额外的代码。依赖的库过多总是一件不太舒服的事情。

## 我们是配置工程师？！

如上文所说，选用的工具多了就会增加额外配置工具的负担。在现在前端开发环境下，我们的工作很大一部分集中在两点：造轮子（重新实现某个别人已经实现的工具）和装轮子（下载已有的工具然后配置）。而实现业务逻辑反倒成了水到渠成的事情，多半是参照别人的代码进行仿写。上一节说的大概就是如何权衡造轮子和装轮子的比重，这一节要说的就是，如果已经决定了要装轮子，那怎么装才是最好的。

所谓配置，目的多半就是“一劳永逸”。理想的结果就是无论以后需求怎么改，项目怎么扩大，我们都可以用很少的工作来实现。可是现实往往是残酷的：我们感觉配置出了一个高度可扩展的环境，结果新的需求偏偏出现在了无法扩展的那个维度上，然后美梦化为泡影，一切又要重来。当这种情况发生时，我们就要反思辛辛苦苦写出一份复杂的配置文件是否是有必要的。

还是用一个例子来说明吧。使用 Webpack 时，少不了会使用各种 loader 来打包不同类型的文件，最常见的就是用 file-loader 来把图片打包，然后在 JavaScript 里直接 require 对应的图片就可以了。此时我们往往会遇到一个选择：究竟是在 webpack.config 里面声明各种类型文件所用的 loader，还是不在 webpack.config 里面声明，而是在 require 文件时声明。直觉上，肯定是把 loader 和文件类型在 webpack.config 里绑定更好，因为这可以很明显的减少我们代码的书写量，并且让 JavaScript 的代码看起来更容易理解，而不必去想那些带着感叹号的 loader 究竟是个什么意思。然而，再仔细想一想的话，这么做有好多问题。比如设计师可能给出来的都是高分辨率的图片，在打包时希望能降低分辨率导出尺寸合适的图片；在处理 responsive 的图片时我们希望一张图片被打包成好几个尺寸不同的版本；页面加载时我们希望可以先加载低分辨率的图片（或者干脆是个占位图）然后再异步加载高分辨率图片，等等。对于这些需求，现在 npm 上已经有各种 loader 来满足我们的需要，但是具体哪张图片使用哪种 loader 这个只有我们自己才知道。在这种情况下，把 loader 和文件类型绑定起来反而会增加不必要的麻烦，因为 webpack 并不知道一句简单的 require 是要原图，压缩过的图还是好几个版本的图。

希望这个例子能够让大家明白配置太多并非是一件好事，有时候在配置文件里少写几句，在代码里多写一点反而会让你的程序更容易扩展。那么到底应该把配置文件写到什么程度才算好呢？我的原则是：在尽量保证开发过程中能够不改变配置文件的前提下，配置得越详细越好。也就是说在开发的最初阶段，我们应该多花一些心思在配置文件上，在以下两点做出权衡：一是配置文件可以减少我们的代码量，二是配置文件在以后能不改动就不改动。当然这其中还是有灵活性的，因为谁也不能保证以后打死都不改配置文件。其实，只要在写配置文件时，能够思考到这二者之间的权衡，往往都可以做出很好的配置。关键的想法是，不要单纯的为了减少代码量而配置，也不要为了最大的可扩展性而干脆不配置。使用 file-loader 来处理图片的例子说明了为了减少代码量而配置的弊端，但并不代表什么 loader 都不用就好，比如 babel-loader 写死在里面就没有问题。

毕竟，配置工程师也只是一个开玩笑的叫法，除了配置之外要干的多了去了。

## 怎么做才是坠吼滴？

随着前端技术的泛滥，在工具的选择上，我们总是希望自己能够遵循“最佳实践”。然而，我写这篇文章最大的目的，就是想说并不存在什么所谓的“最佳实践”，更准确地说，是不存在一种通用的“最佳实践”。每一个项目都有自己独到的地方，每一个开发者都有自己所侧重的东西，每一家公司都有自己习惯的工具和奇怪的癖好。在这种复杂的环境下很难说用什么工具就是最好的，React 未必就比 Angular 要好（希望这句话不会引起争端），用 Gulp 代替 Webpack 也未尝不可。重要的是，在准备一个项目时，我们需要投入时间去思考这个项目的特点，它以后应该是什么样子的，每个工作流程应该是如何执行的，然后再根据这些去选择合适的工具。

**思考才应该是 best practice**

最后，写 ES6 就是要比写 ES5 好，JavaScript 是世界上最好的语言。
